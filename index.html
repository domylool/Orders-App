<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders ‚Äì Stock Take</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#0b0b0b; color:#f3f3f3; }
    header { position:sticky; top:0; background:#111; padding:12px 12px 10px; border-bottom:1px solid #222; z-index:10;}
    h1 { margin:0; font-size:16px; letter-spacing:.2px; }
    .row { display:flex; gap:8px; margin-top:10px; }
    select, input, button, textarea {
      width:100%; padding:10px; border-radius:10px; border:1px solid #2a2a2a;
      background:#141414; color:#f3f3f3; font-size:14px;
    }
    button { background:#1f1f1f; cursor:pointer; }
    button.primary { background:#2b6cff; border-color:#2b6cff; }
    button.danger { background:#c53939; border-color:#c53939; }
    main { padding:12px; }
    .card { background:#111; border:1px solid #222; border-radius:14px; padding:12px; margin:10px 0; }
    .grid { display:grid; grid-template-columns: 1.3fr .7fr .7fr .8fr; gap:8px; align-items:center; }
    .muted { color:#b6b6b6; font-size:12px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#1a1a1a; border:1px solid #2a2a2a; font-size:12px; }
    .qty { text-align:center; font-variant-numeric: tabular-nums; }
    .hr { height:1px; background:#222; margin:10px 0; }
    textarea { min-height:160px; resize:vertical; }
    .small { font-size:12px; }
    .two { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .three { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; }
    @media (max-width: 420px){ .grid{ grid-template-columns: 1.2fr .8fr .8fr .7fr; } }
  </style>
</head>

<body>
<header>
  <h1>üì¶ Stock Take ‚Üí Orders</h1>

  <div class="row">
    <select id="supplierFilter"></select>
    <input id="search" placeholder="Cerca item (es. Etna, Moscato‚Ä¶)" />
  </div>

  <div class="row">
    <button id="showAllBtn">Tutti</button>
    <button id="onlyToOrderBtn">Solo da ordinare</button>
    <button class="primary" id="generateBtn">Genera ordine</button>
  </div>
</header>

<main>
  <div class="card">
    <div class="three">
      <button id="addSupplierBtn">+ Supplier</button>
      <button id="addItemBtn">+ Item</button>
      <button id="manageSuppliersBtn">Gestisci supplier</button>
    </div>

    <div class="two" style="margin-top:8px;">
      <button id="exportBtn">Export backup (JSON)</button>
      <button class="danger" id="resetBtn">Reset dati (attenzione)</button>
    </div>

    <div class="muted" style="margin-top:8px;">
      Compila <b>Stock</b> e <b>Par</b>. ‚ÄúDa ordinare‚Äù = max(0, Par - Stock). Tutto salva automaticamente.
    </div>
  </div>

  <div id="list"></div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div>
        <div style="font-weight:600;">üì≤ Testo ordine (raggruppato per supplier)</div>
        <div class="muted">Copia e incolla su WhatsApp / Email</div>
      </div>
      <button class="primary" id="copyBtn">Copia</button>
    </div>
    <div class="hr"></div>
    <textarea id="orderText" placeholder="Premi ‚ÄúGenera ordine‚Äù‚Ä¶"></textarea>
    <div class="muted small" id="savedHint" style="margin-top:8px;"></div>
  </div>
</main>

<script>
  const STORAGE_KEY = "restaurant_orders_v2";

  // --------- SEED DATA (la tua lista) ----------
  const seedItems = [
    // Alepat Taylor
    { supplier:"Alepat Taylor", category:"Wine", item:"Fantini Calalenta Rosato", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Alepat Taylor", category:"Wine", item:"Il Vignaiolo Pinot Grigio", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Alepat Taylor", category:"Wine", item:"Cusumano Shamaris Grillo", unit:"bt", stock:0, par:0, note:"" },

    // Winestock
    { supplier:"Winestock", category:"Wine", item:"Viberti Moscato D'Asti", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Tenute Ulisse Ros√®", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Terre Dei Miti Etna Bianco", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Tenute Ulisse Montepulciano Red", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Moscone Nebbiolo d'Alba", unit:"bt", stock:0, par:0, note:"" },

    // Arquilla
    { supplier:"Arquilla", category:"Beer", item:"Birra Messina", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Soave", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Planeta Etna Rosso", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Zenato Valpolicella Classico Superiore", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Barberasso Barbera Ripassa", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Castellare Chianti Classico", unit:"bt", stock:0, par:0, note:"" },

    // Twelve Bottles
    { supplier:"Twelve Bottles", category:"Wine", item:"Argiolas Costamolino Vermentino", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Bricco Maiolica Langhe Nebbiolo", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Etna Rosso", unit:"bt", stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Bellavista Gran Cuv√©e Alma Franciacorta", unit:"bt", stock:0, par:0, note:"" },
  ];

  const seedSuppliers = Array.from(new Set(seedItems.map(x => x.supplier))).sort((a,b)=>a.localeCompare(b));

  // --------- STATE ----------
  let state = {
    suppliers: [],
    items: [],
    ui: { supplier:"ALL", onlyToOrder:false, search:"" }
  };

  // --------- UTIL ----------
  function uniq(arr){ return Array.from(new Set(arr)); }
  function cleanName(s){ return (s||"").trim().replace(/\s+/g," "); }
  function calcToOrder(it){
    const s = Number(it.stock)||0;
    const p = Number(it.par)||0;
    return Math.max(0, p - s);
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const hint = document.getElementById("savedHint");
    const now = new Date();
    hint.textContent = "Salvato automaticamente ‚Ä¢ " + now.toLocaleString();
  }

  function migrateIfNeeded(parsed){
    // v1 -> v2: se non c'√® suppliers, deriviamoli dagli items
    if (!parsed) return null;

    const out = {
      suppliers: Array.isArray(parsed.suppliers) ? parsed.suppliers : [],
      items: Array.isArray(parsed.items) ? parsed.items : [],
      ui: parsed.ui || { supplier:"ALL", onlyToOrder:false, search:"" }
    };

    if (!out.suppliers.length && out.items.length){
      out.suppliers = uniq(out.items.map(x => x.supplier)).map(cleanName).sort((a,b)=>a.localeCompare(b));
    }

    // Normalizza supplier name sugli item
    out.items = out.items.map(it => ({
      supplier: cleanName(it.supplier),
      category: cleanName(it.category || "Wine") || "Wine",
      item: cleanName(it.item),
      unit: cleanName(it.unit || "bt") || "bt",
      stock: Number(it.stock)||0,
      par: Number(it.par)||0,
      note: it.note || ""
    })).filter(it => it.supplier && it.item);

    // Se ci sono item con supplier non in lista, aggiungili
    const missing = out.items.map(x=>x.supplier).filter(s => !out.suppliers.includes(s));
    if (missing.length){
      out.suppliers = uniq([...out.suppliers, ...missing]).sort((a,b)=>a.localeCompare(b));
    }

    return out;
  }

  function load() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      state.items = seedItems;
      state.suppliers = seedSuppliers;
      save();
      return;
    }
    try {
      const parsed = JSON.parse(raw);
      const migrated = migrateIfNeeded(parsed);
      if (migrated) state = migrated;
      else {
        state.items = seedItems;
        state.suppliers = seedSuppliers;
      }
      save();
    } catch {
      state.items = seedItems;
      state.suppliers = seedSuppliers;
      save();
    }
  }

  // --------- RENDER ----------
  function renderSupplierFilter(){
    const sel = document.getElementById("supplierFilter");
    const options = ["ALL", ...state.suppliers.slice().sort((a,b)=>a.localeCompare(b))];
    sel.innerHTML = options.map(v => `<option value="${v}">${v === "ALL" ? "Tutti i supplier" : v}</option>`).join("");
    sel.value = state.ui.supplier || "ALL";
  }

  function passesFilters(it){
    const sOk = (state.ui.supplier === "ALL") || it.supplier === state.ui.supplier;
    const q = (state.ui.search||"").trim().toLowerCase();
    const searchOk = !q || (it.item.toLowerCase().includes(q) || it.category.toLowerCase().includes(q) || it.supplier.toLowerCase().includes(q));
    const orderOk = !state.ui.onlyToOrder || calcToOrder(it) > 0;
    return sOk && searchOk && orderOk;
  }

  function renderList(){
    const root = document.getElementById("list");
    const items = state.items
      .slice()
      .sort((a,b)=>(a.supplier+a.category+a.item).localeCompare(b.supplier+b.category+b.item))
      .filter(passesFilters);

    if (!items.length){
      root.innerHTML = `<div class="card"><div class="muted">Nessun item con questi filtri.</div></div>`;
      return;
    }

    root.innerHTML = items.map((it) => {
      const toOrder = calcToOrder(it);
      const pill = toOrder > 0 ? `<span class="pill">Da ordinare: <b>${toOrder}</b></span>` : `<span class="pill">OK</span>`;
      const globalIndex = state.items.indexOf(it);

      return `
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div>
            <div style="font-weight:650;">${it.item}</div>
            <div class="muted">${it.supplier} ‚Ä¢ ${it.category} ‚Ä¢ ${it.unit}</div>
          </div>
          <div>${pill}</div>
        </div>

        <div class="hr"></div>

        <div class="grid">
          <div class="muted">Stock</div>
          <div class="muted qty">Par</div>
          <div class="muted qty">Ordina</div>
          <div class="muted qty">Azioni</div>

          <input inputmode="numeric" value="${it.stock ?? 0}" data-field="stock" data-i="${globalIndex}">
          <input class="qty" inputmode="numeric" value="${it.par ?? 0}" data-field="par" data-i="${globalIndex}">
          <input class="qty" value="${toOrder}" disabled>
          <button class="danger" data-del="${globalIndex}">X</button>
        </div>

        <div style="margin-top:10px;" class="two">
          <input placeholder="Note (opzionale)" value="${it.note || ""}" data-field="note" data-i="${globalIndex}">
          <button data-edit="${globalIndex}">Modifica</button>
        </div>
      </div>`;
    }).join("");

    // Inputs
    root.querySelectorAll("input[data-field]").forEach(inp => {
      inp.addEventListener("input", e => {
        const i = Number(e.target.dataset.i);
        const field = e.target.dataset.field;
        let val = e.target.value;
        if (field === "stock" || field === "par") val = Number(val || 0);
        state.items[i][field] = val;
        save();
        renderList();
      });
    });

    // Delete item
    root.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", e => {
        const i = Number(e.target.dataset.del);
        if (!confirm("Eliminare questo item?")) return;
        state.items.splice(i,1);
        save();
        renderSupplierFilter();
        renderList();
      });
    });

    // Edit item (nome, categoria, unit√†, supplier)
    root.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", e => {
        const i = Number(e.target.dataset.edit);
        const it = state.items[i];

        const newName = cleanName(prompt("Nome item:", it.item));
        if (!newName) return;

        const newSupplier = pickSupplierPrompt("Seleziona supplier per questo item:", it.supplier);
        if (!newSupplier) return;

        const newCategory = cleanName(prompt("Categoria:", it.category || "Wine")) || "Wine";
        const newUnit = cleanName(prompt("Unit√†:", it.unit || "bt")) || "bt";

        it.item = newName;
        it.supplier = newSupplier;
        it.category = newCategory;
        it.unit = newUnit;

        // Se il supplier non esiste, aggiungilo
        if (!state.suppliers.includes(newSupplier)) {
          state.suppliers.push(newSupplier);
          state.suppliers.sort((a,b)=>a.localeCompare(b));
        }

        save();
        renderSupplierFilter();
        renderList();
      });
    });
  }

  // --------- ORDER TEXT ----------
  function generateOrderText(){
    const itemsToOrder = state.items
      .map(it => ({...it, toOrder: calcToOrder(it)}))
      .filter(it => it.toOrder > 0)
      .sort((a,b)=>(a.supplier+a.item).localeCompare(b.supplier+b.item));

    if (!itemsToOrder.length){
      document.getElementById("orderText").value = "Niente da ordinare ‚úÖ";
      return;
    }

    const bySupplier = new Map();
    for (const it of itemsToOrder){
      if (!bySupplier.has(it.supplier)) bySupplier.set(it.supplier, []);
      bySupplier.get(it.supplier).push(it);
    }

    let out = "";
    for (const [supplier, arr] of bySupplier.entries()){
      out += `${supplier}\n`;
      for (const it of arr){
        out += `- ${it.item}: ${it.toOrder} ${it.unit}${it.note ? ` (${it.note})` : ""}\n`;
      }
      out += "\n";
    }
    document.getElementById("orderText").value = out.trim();
  }

  function copyOrder(){
    const txt = document.getElementById("orderText").value || "";
    navigator.clipboard.writeText(txt).then(()=>{
      alert("Copiato ‚úÖ");
    }).catch(()=>{
      alert("Non riesco a copiare. Seleziona il testo e copia manualmente.");
    });
  }

  // --------- SUPPLIERS: CREATE / DELETE ----------
  function addSupplier(){
    const name = cleanName(prompt("Nome nuovo supplier:"));
    if (!name) return;

    if (state.suppliers.some(s => s.toLowerCase() === name.toLowerCase())) {
      alert("Esiste gi√† un supplier con questo nome.");
      return;
    }

    state.suppliers.push(name);
    state.suppliers.sort((a,b)=>a.localeCompare(b));
    save();
    renderSupplierFilter();
    alert("Supplier aggiunto ‚úÖ");
  }

  function deleteSupplierFlow(){
    if (!state.suppliers.length) {
      alert("Non hai supplier da gestire.");
      return;
    }

    const supplier = pickSupplierPrompt("Quale supplier vuoi cancellare?", "");
    if (!supplier) return;

    const itemsCount = state.items.filter(it => it.supplier === supplier).length;

    const ok = confirm(
      `Cancellare supplier "${supplier}"?\n\n` +
      `Questo rimuover√† anche ${itemsCount} item collegati.\n\n` +
      `Vuoi procedere?`
    );
    if (!ok) return;

    // Rimuovi items del supplier
    state.items = state.items.filter(it => it.supplier !== supplier);

    // Rimuovi supplier
    state.suppliers = state.suppliers.filter(s => s !== supplier);

    // Se filtro era su quel supplier, reset
    if (state.ui.supplier === supplier) state.ui.supplier = "ALL";

    save();
    renderSupplierFilter();
    renderList();
    alert("Supplier eliminato ‚úÖ");
  }

  function manageSuppliers(){
    const choice = prompt(
      "Gestisci supplier:\n" +
      "1 = Elimina supplier\n" +
      "2 = Rinomina supplier\n" +
      "3 = Lista supplier\n\n" +
      "Scrivi 1 / 2 / 3"
    );

    if (!choice) return;

    if (choice.trim() === "1") {
      deleteSupplierFlow();
      return;
    }

    if (choice.trim() === "2") {
      renameSupplierFlow();
      return;
    }

    if (choice.trim() === "3") {
      alert("Supplier:\n\n" + state.suppliers.join("\n"));
      return;
    }

    alert("Scelta non valida.");
  }

  function renameSupplierFlow(){
    const oldName = pickSupplierPrompt("Quale supplier vuoi rinominare?", "");
    if (!oldName) return;

    const newName = cleanName(prompt(`Nuovo nome per "${oldName}":`, oldName));
    if (!newName) return;

    if (oldName === newName) return;

    if (state.suppliers.some(s => s.toLowerCase() === newName.toLowerCase())) {
      alert("Esiste gi√† un supplier con questo nome.");
      return;
    }

    // aggiorna supplier list
    state.suppliers = state.suppliers.map(s => s === oldName ? newName : s);

    // aggiorna items
    state.items = state.items.map(it => it.supplier === oldName ? {...it, supplier:newName} : it);

    // aggiorna filtro
    if (state.ui.supplier === oldName) state.ui.supplier = newName;

    state.suppliers.sort((a,b)=>a.localeCompare(b));
    save();
    renderSupplierFilter();
    renderList();
    alert("Supplier rinominato ‚úÖ");
  }

  // Prompt ‚Äúpicker‚Äù semplice (mobile-friendly)
  function pickSupplierPrompt(title, current){
    const list = state.suppliers.slice().sort((a,b)=>a.localeCompare(b));
    const txt =
      `${title}\n\n` +
      list.map((s, idx)=>`${idx+1}. ${s}`).join("\n") +
      `\n\nScrivi il numero (1-${list.length})` +
      (current ? `\n(Attuale: ${current})` : "");
    const ans = prompt(txt);
    if (!ans) return null;
    const n = Number(ans);
    if (!Number.isFinite(n) || n < 1 || n > list.length) {
      alert("Numero non valido.");
      return null;
    }
    return list[n-1];
  }

  // --------- ITEMS: CREATE ----------
  function addItem(){
    if (!state.suppliers.length){
      alert("Prima crea almeno un supplier.");
      return;
    }

    const supplier = pickSupplierPrompt("Seleziona supplier per il nuovo item:", "");
    if (!supplier) return;

    const item = cleanName(prompt("Nome item:"));
    if (!item) return;

    const category = cleanName(prompt("Categoria (Wine/Beer/Spirits/Food‚Ä¶):", "Wine")) || "Wine";
    const unit = cleanName(prompt("Unit√† (bt/kg/ctn‚Ä¶):", "bt")) || "bt";

    // evita duplicati uguali (stesso supplier + item)
    const exists = state.items.some(x =>
      x.supplier.toLowerCase() === supplier.toLowerCase() &&
      x.item.toLowerCase() === item.toLowerCase()
    );
    if (exists) {
      alert("Questo item esiste gi√† per quel supplier.");
      return;
    }

    state.items.push({ supplier, category, item, unit, stock:0, par:0, note:"" });
    save();
    renderSupplierFilter();
    renderList();
  }

  // --------- RESET / EXPORT ----------
  function resetAll(){
    if (!confirm("Reset totale: ripristino lista iniziale e cancello modifiche. Sicuro?")) return;
    state = { suppliers: seedSuppliers, items: seedItems, ui: { supplier:"ALL", onlyToOrder:false, search:"" } };
    save();
    renderSupplierFilter();
    renderList();
    document.getElementById("orderText").value = "";
  }

  function exportBackup(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "orders-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // --------- INIT ----------
  load();
  renderSupplierFilter();
  renderList();

  // UI bindings
  document.getElementById("supplierFilter").addEventListener("change", (e)=>{
    state.ui.supplier = e.target.value;
    save();
    renderList();
  });

  document.getElementById("search").addEventListener("input", (e)=>{
    state.ui.search = e.target.value;
    save();
    renderList();
  });

  document.getElementById("showAllBtn").addEventListener("click", ()=>{
    state.ui.onlyToOrder = false;
    save();
    renderList();
  });

  document.getElementById("onlyToOrderBtn").addEventListener("click", ()=>{
    state.ui.onlyToOrder = true;
    save();
    renderList();
  });

  document.getElementById("generateBtn").addEventListener("click", ()=>{
    generateOrderText();
    save();
  });

  document.getElementById("copyBtn").addEventListener("click", copyOrder);
  document.getElementById("addItemBtn").addEventListener("click", addItem);
  document.getElementById("addSupplierBtn").addEventListener("click", addSupplier);
  document.getElementById("manageSuppliersBtn").addEventListener("click", manageSuppliers);
  document.getElementById("exportBtn").addEventListener("click", exportBackup);
  document.getElementById("resetBtn").addEventListener("click", resetAll);

  // Service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").catch(()=>{});
  }
</script>
</body>
</html>

