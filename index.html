<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Orders â€“ Stock Take</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220" />
  <style>
    /* ---------- THEME ---------- */
    :root{
      --bg:#070b14;
      --surface:#0d1426;
      --surface2:#0b1220;
      --card:#0f1930;
      --card2:#0c152a;
      --text:#eef3ff;
      --muted:#a8b3cf;
      --muted2:#7f8bb0;
      --line:rgba(255,255,255,.08);
      --line2:rgba(255,255,255,.12);
      --primary:#5b8cff;
      --primary2:#2e5fff;
      --danger:#ff4b6b;
      --ok:#2be4a7;
      --warn:#ffcc66;

      --r12:12px;
      --r16:16px;
      --r20:20px;

      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --shadow2: 0 10px 24px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1000px 500px at 30% -10%, rgba(91,140,255,.18), transparent 55%),
        radial-gradient(900px 500px at 110% 20%, rgba(43,228,167,.12), transparent 55%),
        radial-gradient(900px 600px at -10% 60%, rgba(255,204,102,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    a{ color:inherit; }

    /* ---------- APP SHELL ---------- */
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding-bottom: 92px; /* space for bottom action bar */
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      padding: 12px 12px 10px;
      background: linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.82));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }

    .topbarRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex:1;
    }

    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(91,140,255,.95), rgba(43,228,167,.92));
      display:grid;place-items:center;
      box-shadow: 0 10px 28px rgba(91,140,255,.18);
      flex:0 0 auto;
    }
    .logo span{ font-weight:900; color:#081022; letter-spacing:.5px; }

    .titleWrap{ min-width:0; }
    .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size: 15px;
      line-height: 1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .iconBtn{
      width:40px;height:40px;border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:grid;place-items:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      flex:0 0 auto;
    }
    .iconBtn:active{ transform: scale(.98); }
    .iconBtn:hover{ background: rgba(255,255,255,.08); }
    .iconBtn svg{ width:18px;height:18px; opacity:.92; }

    .searchRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .search{
      flex:1;
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
    }
    .search svg{ width:16px;height:16px; opacity:.75; }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .search input::placeholder{ color:rgba(168,179,207,.7); }

    .toggle{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      font-size:13px;
      color:var(--muted);
    }
    .switch{
      width:38px;height:22px;border-radius:999px;
      background: rgba(255,255,255,.12);
      border:1px solid var(--line);
      position:relative;
      flex:0 0 auto;
    }
    .knob{
      width:18px;height:18px;border-radius:999px;
      position:absolute;top:1px;left:1px;
      background: rgba(255,255,255,.92);
      transition: left .16s ease, background .16s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
    }
    .toggle.on{ color:#cfe1ff; border-color: rgba(91,140,255,.35); background: rgba(91,140,255,.12);}
    .toggle.on .switch{ background: rgba(91,140,255,.38); border-color: rgba(91,140,255,.45); }
    .toggle.on .knob{ left: 19px; background:#fff; }

    /* ---------- CHIPS ---------- */
    .chips{
      margin-top:10px;
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width:none;
    }
    .chips::-webkit-scrollbar{ display:none; }
    .chip{
      flex: 0 0 auto;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, border-color .15s ease, color .15s ease, transform .08s ease;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .chip:active{ transform: scale(.99); }
    .chip.on{
      background: rgba(91,140,255,.18);
      border-color: rgba(91,140,255,.42);
      color:#d8e6ff;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.28);
    }
    .chip.on .dot{ background: var(--primary); }

    /* ---------- CONTENT ---------- */
    main{
      padding: 12px;
      max-width: 980px;
      width: 100%;
      margin: 0 auto;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .stat{
      border-radius: 18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 12px 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.20);
      min-width:0;
    }
    .stat .label{ color: var(--muted); font-size:12px; }
    .stat .value{
      margin-top:6px;
      font-weight:900;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .stat .hint{
      margin-top:2px;
      color: var(--muted2);
      font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr; }
    }

    .sectionHeader{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
    }
    .sectionHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      color:#dbe6ff;
    }
    .sectionHeader .meta{
      color: var(--muted2);
      font-size:12px;
      white-space:nowrap;
    }

    /* ---------- ITEM CARDS ---------- */
    .list{ margin-top: 10px; display:flex; flex-direction:column; gap:10px; }

    .itemCard{
      border-radius: 18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding: 12px;
      box-shadow: var(--shadow2);
    }
    .itemTop{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .itemName{
      font-weight:850;
      letter-spacing:.2px;
      line-height:1.25;
      font-size: 15px;
    }
    .itemSub{
      margin-top:4px;
      color: var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 4px 8px;
      border-radius:999px;
    }
    .badge b{ color:#eaf1ff; font-weight:800; }

    .pill{
      flex:0 0 auto;
      padding: 6px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(43,228,167,.35); background: rgba(43,228,167,.10); color:#bff9ea; }
    .pill.todo{ border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.10); color:#ffe3b0; }
    .pill.todo b{ color:#fff; }

    .divider{
      height:1px;
      background: var(--line);
      margin: 10px 0;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }

    .controlBox{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px;
    }
    .controlLabel{
      display:flex;
      justify-content:space-between;
      align-items:center;
      color: var(--muted);
      font-size:12px;
    }
    .controlValue{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .stepper{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      border-radius: 14px;
      padding: 6px;
      width: 100%;
    }
    .stepper button{
      width:32px;height:32px;border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .stepper button:active{ transform: scale(.98); }
    .stepper input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color: var(--text);
      font-weight:900;
      font-size: 16px;
      text-align:center;
      font-variant-numeric: tabular-nums;
    }

    .noteRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .noteRow input{
      flex:1 1 220px;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    .ghostBtn{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      display:flex;gap:8px;align-items:center;
    }
    .ghostBtn svg{ width:16px;height:16px; opacity:.9; }
    .dangerBtn{
      border-color: rgba(255,75,107,.35) !important;
      background: rgba(255,75,107,.10) !important;
      color:#ffd4de !important;
    }

    /* ---------- BOTTOM ACTION BAR ---------- */
    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 60;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(7,11,20,0), rgba(7,11,20,.85) 30%, rgba(7,11,20,.96));
      backdrop-filter: blur(10px);
    }
    .bottomInner{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .primaryBtn{
      width:100%;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid rgba(91,140,255,.45);
      background: linear-gradient(180deg, rgba(91,140,255,.95), rgba(46,95,255,.92));
      color: #081022;
      font-weight: 950;
      letter-spacing:.2px;
      cursor:pointer;
      box-shadow: 0 18px 44px rgba(91,140,255,.22);
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .primaryBtn svg{ width:18px;height:18px; }
    .secondaryBtn{
      width: 52px; height: 48px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      display:grid; place-items:center;
    }
    .secondaryBtn svg{ width:18px;height:18px; opacity:.92; }

    /* ---------- SHEET (ORDER OUTPUT) ---------- */
    .backdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 80;
    }
    .backdrop.on{ display:block; }

    .sheet{
      position: fixed;
      left: 0; right:0; bottom: 0;
      z-index: 90;
      transform: translateY(110%);
      transition: transform .22s ease;
      padding: 0 10px calc(10px + env(safe-area-inset-bottom));
    }
    .sheet.on{ transform: translateY(0); }

    .sheetInner{
      max-width: 980px;
      margin: 0 auto;
      border-radius: 22px;
      border:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(15,25,48,.98), rgba(11,18,32,.98));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHeader{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--line);
    }
    .handle{
      width: 44px; height: 5px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      margin: 10px auto 0;
    }
    .sheetTitle{
      font-weight:900;
      letter-spacing:.2px;
      font-size:14px;
    }
    .sheetActions{ display:flex; gap:8px; align-items:center; }
    .sheetActions button{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .sheetActions button.primary{
      border-color: rgba(43,228,167,.35);
      background: rgba(43,228,167,.12);
      color:#d6fff3;
    }
    .sheetBody{
      padding: 12px;
    }
    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      line-height: 1.45;
      outline:none;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%) translateY(20px);
      opacity:0;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(15,25,48,.95);
      color: var(--text);
      font-size: 13px;
      z-index: 120;
      box-shadow: var(--shadow2);
      transition: opacity .16s ease, transform .16s ease;
      pointer-events:none;
    }
    .toast.on{ opacity:1; transform: translateX(-50%) translateY(0); }

    /* ---------- EMPTY ---------- */
    .empty{
      border-radius: 18px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
      padding: 14px;
      color: var(--muted);
      text-align:center;
    }

    /* ---------- REDUCE MOTION ---------- */
    @media (prefers-reduced-motion: reduce){
      .sheet, .toggle .knob, .toast{ transition:none !important; }
    }
  </style>
</head>

<body>
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbarRow">
      <div class="brand">
        <div class="logo"><span>ST</span></div>
        <div class="titleWrap">
          <div class="title">Stock Take & Orders</div>
          <div class="subtitle" id="subtitle">Raggruppa per supplier, copia e invia</div>
        </div>
      </div>

      <button class="iconBtn" id="manageBtn" title="Gestisci">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M4 7h10M18 7h2M12 7v10M4 17h6M14 17h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="iconBtn" id="orderBtnTop" title="Ordine">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 3h12v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 7h6M9 11h6M9 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="searchRow">
      <div class="search">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
          <path d="M16.2 16.2 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="search" placeholder="Cerca item, categoria o supplierâ€¦" />
      </div>

      <div class="toggle" id="onlyToggle" title="Mostra solo ciÃ² che devi ordinare">
        <div class="switch"><div class="knob"></div></div>
        Solo ordini
      </div>
    </div>

    <div class="chips" id="chips"></div>
  </div>

  <main>
    <!-- STATS -->
    <div class="stats" id="stats"></div>

    <div class="sectionHeader">
      <h2 id="sectionTitle">Items</h2>
      <div class="meta" id="sectionMeta"></div>
    </div>

    <div class="list" id="list"></div>
  </main>

  <!-- BOTTOM BAR -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="secondaryBtn" id="addItemBtn" title="Aggiungi item">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <button class="primaryBtn" id="generateBtn">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M13 2 3 14h7l-1 8 12-14h-7l-1-6z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
        Genera ordine
      </button>

      <button class="secondaryBtn" id="orderBtn" title="Apri ordine">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M6 3h12v18l-2-1-2 1-2-1-2 1-2-1-2 1V3z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 7h6M9 11h6M9 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

</div>

<!-- ORDER SHEET -->
<div class="backdrop" id="backdrop"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="handle"></div>
    <div class="sheetHeader">
      <div>
        <div class="sheetTitle">ðŸ“² Ordine pronto (per WhatsApp / Email)</div>
        <div style="color:var(--muted); font-size:12px; margin-top:2px;" id="savedHint">Salvataggio automatico</div>
      </div>
      <div class="sheetActions">
        <button id="copyBtn" class="primary">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M8 8h11v13H8V8z" stroke="currentColor" stroke-width="2" />
            <path d="M5 16H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Copia
        </button>
        <button id="closeSheetBtn">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Chiudi
        </button>
      </div>
    </div>
    <div class="sheetBody">
      <textarea id="orderText" placeholder="Premi â€œGenera ordineâ€â€¦"></textarea>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copiato âœ…</div>

<script>
  const STORAGE_KEY = "restaurant_orders_pro_v2_prices";

  // -------- valuta (modifica qui se vuoi) --------
  const CURRENCY = "A$";

  // ----------------- SEED -----------------
  const seedItems = [
    { supplier:"Alepat Taylor", category:"Wine", item:"Fantini Calalenta Rosato", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Alepat Taylor", category:"Wine", item:"Il Vignaiolo Pinot Grigio", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Alepat Taylor", category:"Wine", item:"Cusumano Shamaris Grillo", unit:"bt", price:0, stock:0, par:0, note:"" },

    { supplier:"Winestock", category:"Wine", item:"Viberti Moscato D'Asti", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Tenute Ulisse RosÃ¨", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Terre Dei Miti Etna Bianco", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Tenute Ulisse Montepulciano Red", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Winestock", category:"Wine", item:"Moscone Nebbiolo d'Alba", unit:"bt", price:0, stock:0, par:0, note:"" },

    { supplier:"Arquilla", category:"Beer", item:"Birra Messina", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Soave", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Planeta Etna Rosso", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Zenato Valpolicella Classico Superiore", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Barberasso Barbera Ripassa", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Arquilla", category:"Wine", item:"Castellare Chianti Classico", unit:"bt", price:0, stock:0, par:0, note:"" },

    { supplier:"Twelve Bottles", category:"Wine", item:"Argiolas Costamolino Vermentino", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Bricco Maiolica Langhe Nebbiolo", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Etna Rosso", unit:"bt", price:0, stock:0, par:0, note:"" },
    { supplier:"Twelve Bottles", category:"Wine", item:"Bellavista Gran CuvÃ©e Alma Franciacorta", unit:"bt", price:0, stock:0, par:0, note:"" },
  ];

  const seedSuppliers = Array.from(new Set(seedItems.map(x => x.supplier))).sort((a,b)=>a.localeCompare(b));

  // ----------------- STATE -----------------
  let state = {
    suppliers: [],
    items: [],
    ui: { supplier:"ALL", onlyToOrder:false, search:"" }
  };

  // ----------------- HELPERS -----------------
  const $ = (id) => document.getElementById(id);

  function uniq(arr){ return Array.from(new Set(arr)); }
  function clean(s){ return (s||"").trim().replace(/\s+/g," "); }

  function parseMoney(v){
    const n = Number(String(v ?? "").replace(",", "."));
    if (!Number.isFinite(n) || n < 0) return 0;
    return n;
  }

  function calcToOrder(it){
    const s = Number(it.stock)||0;
    const p = Number(it.par)||0;
    return Math.max(0, p - s);
  }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("on");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>t.classList.remove("on"), 1100);
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const now = new Date();
    $("savedHint").textContent = "Salvato automaticamente â€¢ " + now.toLocaleString();
  }

  function migrate(parsed){
    const out = {
      suppliers: Array.isArray(parsed?.suppliers) ? parsed.suppliers : [],
      items: Array.isArray(parsed?.items) ? parsed.items : [],
      ui: parsed?.ui || { supplier:"ALL", onlyToOrder:false, search:"" }
    };

    if (!out.suppliers.length && out.items.length){
      out.suppliers = uniq(out.items.map(x=>x.supplier)).map(clean).sort((a,b)=>a.localeCompare(b));
    }

    // include price
    out.items = out.items.map(it => ({
      supplier: clean(it.supplier),
      category: clean(it.category || "Wine") || "Wine",
      item: clean(it.item),
      unit: clean(it.unit || "bt") || "bt",
      price: Math.max(0, Number(it.price || 0) || 0),
      stock: Number(it.stock)||0,
      par: Number(it.par)||0,
      note: it.note || ""
    })).filter(it => it.supplier && it.item);

    const missing = out.items.map(x=>x.supplier).filter(s => !out.suppliers.includes(s));
    if (missing.length) out.suppliers = uniq([...out.suppliers, ...missing]).sort((a,b)=>a.localeCompare(b));

    return out;
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw){
      state.items = seedItems;
      state.suppliers = seedSuppliers;
      save();
      return;
    }
    try{
      state = migrate(JSON.parse(raw));
      save();
    }catch{
      state.items = seedItems;
      state.suppliers = seedSuppliers;
      save();
    }
  }

  // ----------------- FILTERS -----------------
  function passes(it){
    const sOk = state.ui.supplier === "ALL" || it.supplier === state.ui.supplier;
    const q = (state.ui.search||"").trim().toLowerCase();
    const searchOk = !q || it.item.toLowerCase().includes(q) || it.category.toLowerCase().includes(q) || it.supplier.toLowerCase().includes(q);
    const orderOk = !state.ui.onlyToOrder || calcToOrder(it) > 0;
    return sOk && searchOk && orderOk;
  }

  // ----------------- UI: CHIPS + STATS + LIST -----------------
  function renderChips(){
    const chips = $("chips");
    const suppliers = ["ALL", ...state.suppliers.slice().sort((a,b)=>a.localeCompare(b))];
    chips.innerHTML = suppliers.map(s => {
      const on = (state.ui.supplier === s) ? "on" : "";
      const label = (s === "ALL") ? "Tutti" : s;
      return `<div class="chip ${on}" data-s="${escapeHtml(s)}"><span class="dot"></span>${escapeHtml(label)}</div>`;
    }).join("");

    chips.querySelectorAll(".chip").forEach(ch => {
      ch.addEventListener("click", ()=>{
        state.ui.supplier = ch.dataset.s;
        save();
        render();
      });
    });
  }

  function renderStats(){
    const itemsAll = state.items.filter(passes);
    const totalItems = itemsAll.length;
    const toOrderCount = itemsAll.filter(it => calcToOrder(it) > 0).length;
    const suppliersActive = uniq(itemsAll.map(it => it.supplier)).length;

    const totalGlobal = state.items.length;
    const toOrderGlobal = state.items.filter(it => calcToOrder(it) > 0).length;

    $("stats").innerHTML = `
      <div class="stat">
        <div class="label">Items visibili</div>
        <div class="value">${totalItems}</div>
        <div class="hint">Totali nel database: ${totalGlobal}</div>
      </div>
      <div class="stat">
        <div class="label">Da ordinare</div>
        <div class="value">${toOrderCount}</div>
        <div class="hint">Totale da ordinare: ${toOrderGlobal}</div>
      </div>
      <div class="stat">
        <div class="label">Supplier attivi</div>
        <div class="value">${suppliersActive}</div>
        <div class="hint">${state.ui.supplier === "ALL" ? "Tutti i supplier" : state.ui.supplier}</div>
      </div>
    `;
  }

  function renderMeta(){
    const visible = state.items.filter(passes);
    const toOrder = visible.filter(it => calcToOrder(it) > 0).length;
    $("sectionTitle").textContent = "Items";
    $("sectionMeta").textContent = `${visible.length} visibili â€¢ ${toOrder} da ordinare`;
    $("subtitle").textContent = state.ui.supplier === "ALL" ? "Tutti i supplier" : `Supplier: ${state.ui.supplier}`;
  }

  function renderList(){
    const root = $("list");
    const items = state.items
      .slice()
      .sort((a,b)=>(a.supplier+a.category+a.item).localeCompare(b.supplier+b.category+b.item))
      .filter(passes);

    if (!items.length){
      root.innerHTML = `<div class="empty">Nessun item con questi filtri. Prova a cambiare supplier o ricerca.</div>`;
      return;
    }

    root.innerHTML = items.map((it) => {
      const idx = state.items.indexOf(it);
      const toOrder = calcToOrder(it);
      const pill = toOrder > 0
        ? `<div class="pill todo">Da ordinare: <b>${toOrder}</b> ${escapeHtml(it.unit)}</div>`
        : `<div class="pill ok">OK</div>`;

      const priceTxt = `${CURRENCY}${Number(it.price || 0).toFixed(2)}`;

      return `
        <div class="itemCard" data-i="${idx}">
          <div class="itemTop">
            <div style="min-width:0;">
              <div class="itemName">${escapeHtml(it.item)}</div>
              <div class="itemSub">
                <span class="badge"><span style="opacity:.7;">Supplier</span> <b>${escapeHtml(it.supplier)}</b></span>
                <span class="badge"><span style="opacity:.7;">Cat</span> <b>${escapeHtml(it.category)}</b></span>
                <span class="badge"><span style="opacity:.7;">Unit</span> <b>${escapeHtml(it.unit)}</b></span>
                <span class="badge" style="cursor:pointer;" title="Tocca per cambiare prezzo" data-price>
                  <span style="opacity:.7;">Prezzo</span> <b>${escapeHtml(priceTxt)}</b>
                </span>
              </div>
            </div>
            ${pill}
          </div>

          <div class="divider"></div>

          <div class="controls">
            <div class="controlBox">
              <div class="controlLabel">
                <span>Stock</span>
                <span style="color:var(--muted2);">attuale</span>
              </div>
              <div class="controlValue">
                <div class="stepper">
                  <button data-step="stock" data-d="-1" title="-1">â€“</button>
                  <input inputmode="numeric" data-field="stock" value="${it.stock ?? 0}">
                  <button data-step="stock" data-d="1" title="+1">+</button>
                </div>
              </div>
            </div>

            <div class="controlBox">
              <div class="controlLabel">
                <span>Par</span>
                <span style="color:var(--muted2);">target</span>
              </div>
              <div class="controlValue">
                <div class="stepper">
                  <button data-step="par" data-d="-1" title="-1">â€“</button>
                  <input inputmode="numeric" data-field="par" value="${it.par ?? 0}">
                  <button data-step="par" data-d="1" title="+1">+</button>
                </div>
              </div>
            </div>
          </div>

          <div class="noteRow">
            <input placeholder="Note (opzionale)" data-field="note" value="${escapeHtml(it.note || "")}">
            <button class="ghostBtn" data-edit title="Modifica item">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8l-1.2-1.2a2 2 0 0 0-2.8 0L4 16v4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M13.5 6.5l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Modifica
            </button>
            <button class="ghostBtn dangerBtn" data-del title="Elimina item">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M6 7l1-3h10l1 3v14a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
              Elimina
            </button>
          </div>
        </div>
      `;
    }).join("");

    // bind inside cards
    root.querySelectorAll(".itemCard").forEach(card => {
      const i = Number(card.dataset.i);
      const it = state.items[i];

      // change price quickly
      const priceBadge = card.querySelector("[data-price]");
      if (priceBadge){
        priceBadge.addEventListener("click", ()=>{
          const v = prompt("Prezzo unitario (es. 18.50). Lascia vuoto per 0.", String(Number(it.price||0)));
          if (v === null) return;
          it.price = parseMoney(v);
          save();
          render();
          toast("Prezzo aggiornato");
        });
      }

      // edit item
      const editBtn = card.querySelector("button[data-edit]");
      if (editBtn){
        editBtn.addEventListener("click", ()=>{
          editItemFlow(i);
        });
      }

      // stepper +/- buttons
      card.querySelectorAll("button[data-step]").forEach(btn => {
        btn.addEventListener("click", ()=>{
          const field = btn.dataset.step;
          const delta = Number(btn.dataset.d);
          it[field] = Math.max(0, (Number(it[field])||0) + delta);
          save();
          render();
        });
      });

      // direct input for stock/par/note
      card.querySelectorAll("input[data-field]").forEach(inp => {
        inp.addEventListener("input", ()=>{
          const field = inp.dataset.field;
          let v = inp.value;

          if (field === "stock" || field === "par"){
            v = Number(v || 0);
            if (!Number.isFinite(v) || v < 0) v = 0;
          }
          it[field] = v;
          save();
          renderStats();
          renderMeta();
          debounceRender();
        });
      });

      // delete
      const del = card.querySelector("button[data-del]");
      del.addEventListener("click", ()=>{
        if (!confirm("Eliminare questo item?")) return;
        state.items.splice(i,1);
        save();
        render();
      });
    });
  }

  let _deb;
  function debounceRender(){
    clearTimeout(_deb);
    _deb = setTimeout(()=>render(), 120);
  }

  // ----------------- EDIT ITEM FLOW -----------------
  function editItemFlow(index){
    const it = state.items[index];
    if (!it) return;

    const newName = clean(prompt("Nome item:", it.item));
    if (!newName) return;

    const sortedSuppliers = state.suppliers.slice().sort((a,b)=>a.localeCompare(b));
    const supplierChoice = prompt(
      "Supplier:\n\n" +
      sortedSuppliers.map((s,i)=>`${i+1}. ${s}`).join("\n") +
      "\n\nScrivi il numero oppure scrivi un nuovo nome supplier:",
      it.supplier
    );
    if (supplierChoice === null) return;

    let newSupplier = clean(supplierChoice);
    const n = Number(supplierChoice);
    if (Number.isFinite(n) && n >= 1 && n <= sortedSuppliers.length){
      newSupplier = sortedSuppliers[n-1];
    }
    if (!newSupplier) return;

    const newCategory = clean(prompt("Categoria:", it.category || "Wine")) || "Wine";
    const newUnit = clean(prompt("UnitÃ  (bt/kg/ctnâ€¦):", it.unit || "bt")) || "bt";

    const priceStr = prompt("Prezzo unitario (es. 18.50):", String(Number(it.price||0)));
    if (priceStr === null) return;
    const newPrice = parseMoney(priceStr);

    // avoid duplicates supplier+item
    const duplicate = state.items.some((x, idx) =>
      idx !== index &&
      x.supplier.toLowerCase() === newSupplier.toLowerCase() &&
      x.item.toLowerCase() === newName.toLowerCase()
    );
    if (duplicate){
      alert("Esiste giÃ  un item con questo nome per quel supplier.");
      return;
    }

    it.item = newName;
    it.supplier = newSupplier;
    it.category = newCategory;
    it.unit = newUnit;
    it.price = newPrice;

    if (!state.suppliers.some(s => s.toLowerCase() === newSupplier.toLowerCase())){
      state.suppliers.push(newSupplier);
      state.suppliers.sort((a,b)=>a.localeCompare(b));
    }

    save();
    render();
    toast("Item aggiornato");
  }

  // ----------------- ORDER (SHEET) -----------------
  function openSheet(){
    $("backdrop").classList.add("on");
    $("sheet").classList.add("on");
  }
  function closeSheet(){
    $("backdrop").classList.remove("on");
    $("sheet").classList.remove("on");
  }

  // order with totals per supplier + grand total
  function generateOrderText(){
    const rows = state.items
      .map(it => {
        const qty = calcToOrder(it);
        if (qty <= 0) return null;
        const price = Math.max(0, Number(it.price||0) || 0);
        const lineTotal = qty * price;
        return { ...it, qty, price, lineTotal };
      })
      .filter(Boolean)
      .sort((a,b)=>(a.supplier+a.item).localeCompare(b.supplier+b.item));

    if (!rows.length){
      $("orderText").value = "Niente da ordinare âœ…";
      return;
    }

    const bySupplier = new Map();
    for (const r of rows){
      if (!bySupplier.has(r.supplier)) bySupplier.set(r.supplier, []);
      bySupplier.get(r.supplier).push(r);
    }

    let grandTotal = 0;
    let out = "";

    for (const [supplier, arr] of bySupplier.entries()){
      let supplierTotal = 0;

      out += `${supplier}\n`;
      for (const r of arr){
        supplierTotal += r.lineTotal;

        const priceTxt = `${CURRENCY}${(r.price || 0).toFixed(2)}`;
        const lineTxt = (r.price > 0) ? ` = ${CURRENCY}${r.lineTotal.toFixed(2)}` : "";

        out += `- ${r.item}: ${r.qty} ${r.unit} x ${priceTxt}${lineTxt}${r.note ? ` (${r.note})` : ""}\n`;
      }

      grandTotal += supplierTotal;
      out += `Totale ${supplier}: ${CURRENCY}${supplierTotal.toFixed(2)}\n\n`;
    }

    out += `TOTALE GENERALE: ${CURRENCY}${grandTotal.toFixed(2)}`;
    $("orderText").value = out.trim();
  }

  async function copyOrder(){
    const txt = $("orderText").value || "";
    try{
      await navigator.clipboard.writeText(txt);
      toast("Copiato âœ…");
    }catch{
      toast("Copia non disponibile");
      alert("Non riesco a copiare. Seleziona il testo e copia manualmente.");
    }
  }

  // ----------------- MANAGE (PROMPT MENU) -----------------
  function pickSupplier(title){
    const list = state.suppliers.slice().sort((a,b)=>a.localeCompare(b));
    if (!list.length) return null;
    const msg = `${title}\n\n` + list.map((s,i)=>`${i+1}. ${s}`).join("\n") + `\n\nScrivi il numero (1-${list.length})`;
    const ans = prompt(msg);
    if (!ans) return null;
    const n = Number(ans);
    if (!Number.isFinite(n) || n<1 || n>list.length){ alert("Numero non valido."); return null; }
    return list[n-1];
  }

  function addSupplier(){
    const name = clean(prompt("Nome nuovo supplier:"));
    if (!name) return;
    if (state.suppliers.some(s => s.toLowerCase() === name.toLowerCase())){
      alert("Esiste giÃ  un supplier con questo nome.");
      return;
    }
    state.suppliers.push(name);
    state.suppliers.sort((a,b)=>a.localeCompare(b));
    save();
    render();
    toast("Supplier aggiunto");
  }

  function renameSupplier(){
    const oldName = pickSupplier("Quale supplier vuoi rinominare?");
    if (!oldName) return;
    const newName = clean(prompt(`Nuovo nome per "${oldName}":`, oldName));
    if (!newName) return;
    if (newName.toLowerCase() === oldName.toLowerCase()) return;

    if (state.suppliers.some(s => s.toLowerCase() === newName.toLowerCase())){
      alert("Esiste giÃ  un supplier con questo nome.");
      return;
    }

    state.suppliers = state.suppliers.map(s => s === oldName ? newName : s);
    state.items = state.items.map(it => it.supplier === oldName ? {...it, supplier:newName} : it);
    if (state.ui.supplier === oldName) state.ui.supplier = newName;

    state.suppliers.sort((a,b)=>a.localeCompare(b));
    save();
    render();
    toast("Supplier rinominato");
  }

  function deleteSupplier(){
    const supplier = pickSupplier("Quale supplier vuoi eliminare?");
    if (!supplier) return;

    const count = state.items.filter(it => it.supplier === supplier).length;
    const ok = confirm(`Eliminare "${supplier}"?\n\nVerranno rimossi anche ${count} item collegati.`);
    if (!ok) return;

    state.items = state.items.filter(it => it.supplier !== supplier);
    state.suppliers = state.suppliers.filter(s => s !== supplier);
    if (state.ui.supplier === supplier) state.ui.supplier = "ALL";

    save();
    render();
    toast("Supplier eliminato");
  }

  function addItemFlow(){
    if (!state.suppliers.length){
      alert("Prima crea almeno un supplier.");
      return;
    }
    const supplier = pickSupplier("Seleziona supplier per il nuovo item:");
    if (!supplier) return;

    const item = clean(prompt("Nome item:"));
    if (!item) return;

    const category = clean(prompt("Categoria (Wine/Beer/Spirits/Foodâ€¦):", "Wine")) || "Wine";
    const unit = clean(prompt("UnitÃ  (bt/kg/ctnâ€¦):", "bt")) || "bt";
    const priceStr = prompt("Prezzo unitario (opzionale, es. 18.50):", "0");
    if (priceStr === null) return;
    const price = parseMoney(priceStr);

    const exists = state.items.some(x =>
      x.supplier.toLowerCase() === supplier.toLowerCase() &&
      x.item.toLowerCase() === item.toLowerCase()
    );
    if (exists){
      alert("Questo item esiste giÃ  per quel supplier.");
      return;
    }

    state.items.push({ supplier, category, item, unit, price, stock:0, par:0, note:"" });
    save();
    render();
    toast("Item aggiunto");
  }

  function exportBackup(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "orders-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Backup esportato");
  }

  function resetAll(){
    const ok = confirm("Reset totale: ripristino lista iniziale e cancello modifiche. Sicuro?");
    if (!ok) return;
    state = { suppliers: seedSuppliers, items: seedItems, ui: { supplier:"ALL", onlyToOrder:false, search:"" } };
    save();
    render();
    $("orderText").value = "";
    toast("Reset completato");
  }

  function manageMenu(){
    const choice = prompt(
      "Gestisci:\n\n" +
      "1 = + Supplier\n" +
      "2 = Rinomina supplier\n" +
      "3 = Elimina supplier\n" +
      "4 = + Item\n" +
      "5 = Export backup (JSON)\n" +
      "6 = Reset dati\n\n" +
      "Scrivi 1-6"
    );
    if (!choice) return;
    switch(choice.trim()){
      case "1": addSupplier(); break;
      case "2": renameSupplier(); break;
      case "3": deleteSupplier(); break;
      case "4": addItemFlow(); break;
      case "5": exportBackup(); break;
      case "6": resetAll(); break;
      default: alert("Scelta non valida.");
    }
  }

  // ----------------- RENDER WRAPPER -----------------
  function render(){
    renderChips();
    renderStats();
    renderMeta();
    renderList();
    const t = $("onlyToggle");
    if (state.ui.onlyToOrder) t.classList.add("on"); else t.classList.remove("on");
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ----------------- INIT -----------------
  load();
  render();

  // Search
  $("search").value = state.ui.search || "";
  $("search").addEventListener("input", (e)=>{
    state.ui.search = e.target.value;
    save();
    render();
  });

  // Toggle only-to-order
  $("onlyToggle").addEventListener("click", ()=>{
    state.ui.onlyToOrder = !state.ui.onlyToOrder;
    save();
    render();
  });

  // Generate + open sheet
  function doGenerateOpen(){
    generateOrderText();
    save();
    openSheet();
  }
  $("generateBtn").addEventListener("click", doGenerateOpen);

  // Open sheet buttons
  $("orderBtn").addEventListener("click", openSheet);
  $("orderBtnTop").addEventListener("click", openSheet);

  // Copy / close
  $("copyBtn").addEventListener("click", copyOrder);
  $("closeSheetBtn").addEventListener("click", closeSheet);
  $("backdrop").addEventListener("click", closeSheet);

  // Add item quick
  $("addItemBtn").addEventListener("click", addItemFlow);

  // Manage
  $("manageBtn").addEventListener("click", manageMenu);

  // Service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").catch(()=>{});
  }
</script>
</body>
</html>
